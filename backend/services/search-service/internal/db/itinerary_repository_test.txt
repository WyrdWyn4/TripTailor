package db

import (
	"testing"

	sqlmock "github.com/DATA-DOG/go-sqlmock"
	"github.com/lib/pq"
	assert "github.com/stretchr/testify/assert"
	//"github.com/jordyob03/TripTailor/backend/services/search-service/internal/models"
)

func TestGetScoredItineraries(t *testing.T) {
	database, mock, err := sqlmock.New()
	if err != nil {
		t.Fatalf("an error '%s' was not expected when opening a stub database connection", err)
	}
	defer database.Close()

	// Mock parameters
	params := map[string]interface{}{
		"city":      "Tokyo",
		"languages": []string{"Japanese", "English"},
		"tags":      []string{"food", "adventure"},
		"price":     200.0,
	}

	// Simplified query regex for sqlmock
	query := `SELECT \* FROM $begin:math:text$SELECT \\*, \\(.*?$end:math:text$ AS total_score FROM itineraries\) AS scored_itineraries WHERE total_score >= \d ORDER BY total_score DESC`

	// Mock expected rows
	rows := sqlmock.NewRows([]string{
		"itineraryid", "name", "city", "country", "title", "description", "price", "languages", "tags", "events", "postid", "username", "total_score",
	}).
		AddRow(3, "Tokyo Food Tour", "Tokyo", "Japan", "Taste of Tokyo", "Delve into the best sushi and ramen in Tokyo.", 150.0, pq.Array([]string{"Japanese", "English"}), pq.Array([]string{"food", "sushi"}), pq.Array([]string{"event1", "event2"}), 101, "user1", 3).
		AddRow(4, "Tokyo Nightlife", "Tokyo", "Japan", "Night Owls", "Enjoy Tokyo's vibrant nightlife scene.", 180.0, pq.Array([]string{"Japanese", "English"}), pq.Array([]string{"nightlife", "club"}), pq.Array([]string{"event3", "event4"}), 102, "user2", 2)

	mock.ExpectQuery(query).
		WithArgs(params["city"], pq.Array(params["languages"]), pq.Array(params["tags"]), params["price"]).
		WillReturnRows(rows)

	// Call the function
	itineraries, err := GetScoredItineraries(database, params)

	// Assertions
	assert.NoError(t, err)
	assert.Len(t, itineraries, 2)

	// Check the first itinerary
	assert.Equal(t, 3, itineraries[0].Itinerary.ItineraryId)
	assert.Equal(t, "Tokyo Food Tour", itineraries[0].Itinerary.Name)
	assert.Equal(t, 3, itineraries[0].TotalMatchCount)

	// Check the second itinerary
	assert.Equal(t, 4, itineraries[1].Itinerary.ItineraryId)
	assert.Equal(t, "Tokyo Nightlife", itineraries[1].Itinerary.Name)
	assert.Equal(t, 2, itineraries[1].TotalMatchCount)

	// Ensure all expectations are met
	if err := mock.ExpectationsWereMet(); err != nil {
		t.Errorf("there were unfulfilled expectations: %s", err)
	}
}
