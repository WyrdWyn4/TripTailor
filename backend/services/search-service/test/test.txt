package handlers_test

import (
	"database/sql"
	"encoding/json"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/gin-gonic/gin"
	db "github.com/jordyob03/TripTailor/backend/services/search-service/internal/db"
	"github.com/jordyob03/TripTailor/backend/services/search-service/internal/handlers"
	"github.com/stretchr/testify/assert"
)

func TestSearchItineraries_ValidParams(t *testing.T) {
	gin.SetMode(gin.TestMode)

	mockDB := &sql.DB{}

	expectedItineraries := []db.Itinerary{
		{ItineraryId: 1, City: "Tokyo", Country: "Japan", Title: "Food Tour"},
		{ItineraryId: 2, City: "Paris", Country: "France", Title: "Romantic Getaway"},
	}

	db.GetScoredItineraries = func(dbConn *sql.DB, params map[string]interface{}) ([]db.Itinerary, error) {
		return expectedItineraries, nil
	}

	w := httptest.NewRecorder()
	c, _ := gin.CreateTestContext(w)

	c.Request, _ = http.NewRequest("GET", "/search?languages=Japanese,English&city=Tokyo&tags=food", nil)

	handlers.SearchItineraries(mockDB)(c)

	assert.Equal(t, http.StatusOK, w.Code)

	var response []db.Itinerary
	err := json.Unmarshal(w.Body.Bytes(), &response)
	assert.NoError(t, err)
	assert.Equal(t, expectedItineraries, response)
}

func TestSearchItineraries_NoParams(t *testing.T) {
	gin.SetMode(gin.TestMode)

	mockDB := &sql.DB{}

	expectedItineraries := []db.Itinerary{
		{ItineraryId: 1, City: "Tokyo", Country: "Japan", Title: "Food Tour"},
		{ItineraryId: 2, City: "Paris", Country: "France", Title: "Romantic Getaway"},
	}

	db.GetScoredItineraries = func(dbConn *sql.DB, params map[string]interface{}) ([]db.Itinerary, error) {
		return expectedItineraries, nil
	}

	w := httptest.NewRecorder()
	c, _ := gin.CreateTestContext(w)

	c.Request, _ = http.NewRequest("GET", "/search", nil)

	handlers.SearchItineraries(mockDB)(c)

	assert.Equal(t, http.StatusOK, w.Code)

	var response []db.Itinerary
	err := json.Unmarshal(w.Body.Bytes(), &response)
	assert.NoError(t, err)
	assert.Equal(t, expectedItineraries, response)
}

func TestSearchItineraries_DatabaseError(t *testing.T) {
	gin.SetMode(gin.TestMode)

	mockDB := &sql.DB{}

	db.GetScoredItineraries = func(dbConn *sql.DB, params map[string]interface{}) ([]db.Itinerary, error) {
		return nil, sql.ErrConnDone
	}

	w := httptest.NewRecorder()
	c, _ := gin.CreateTestContext(w)

	c.Request, _ = http.NewRequest("GET", "/search?languages=Japanese,English&price=200", nil)

	handlers.SearchItineraries(mockDB)(c)

	assert.Equal(t, http.StatusInternalServerError, w.Code)

	var response map[string]string
	err := json.Unmarshal(w.Body.Bytes(), &response)
	assert.NoError(t, err)
	assert.Equal(t, sql.ErrConnDone.Error(), response["error"])
}
